@model List<ProgrammingPOE.Models.Claim>
@{
    ViewData["Title"] = "Coordinator - Claim Verification";
}

<h2>Claims Pending Coordinator Verification</h2>
<hr />

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        @TempData["SuccessMessage"]
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">
        @TempData["ErrorMessage"]
    </div>
}

<!-- Bulk Actions Card -->
<div class="card mb-3">
    <div class="card-header bg-warning">
        <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Bulk Actions</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <select id="bulkAction" class="form-select">
                    <option value="">Select Bulk Action</option>
                    <option value="verify">Verify Selected Claims</option>
                    <option value="reject">Reject Selected Claims</option>
                </select>
            </div>
            <div class="col-md-4">
                <button type="button" class="btn btn-primary w-100" onclick="performBulkAction()">
                    <i class="fas fa-play me-1"></i>Execute Bulk Action
                </button>
            </div>
        </div>
        <div class="mt-2">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Select multiple claims and perform bulk verification or rejection
            </small>
        </div>
    </div>
</div>

@if (!Model.Any())
{
    <div class="alert alert-info">
        <p>No claims pending verification.</p>
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th width="50px">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                    </th>
                    <th>Claim ID</th>
                    <th>Lecturer</th>
                    <th>Submission Date</th>
                    <th>Hours</th>
                    <th>Rate</th>
                    <th>Total Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var claim in Model)
                {
                    <tr>
                        <td>
                            <input type="checkbox" class="claim-checkbox" value="@claim.Id">
                        </td>
                        <td>@claim.Id</td>
                        <td>@claim.LecturerName</td>
                        <td>@claim.SubmissionDate.ToString("dd MMM yyyy")</td>
                        <td>@claim.HoursWorked</td>
                        <td>R @claim.HourlyRate</td>
                        <td>R @claim.TotalAmount</td>
                        <td>
                            @if (claim.Status == ProgrammingPOE.Models.ClaimStatus.RejectedByHR)
                            {
                                <span class="badge bg-danger">Returned by HR</span>
                            }
                            else
                            {
                                <span class="badge bg-warning">Pending Verification</span>
                            }
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                @if (claim.Status == ProgrammingPOE.Models.ClaimStatus.Submitted)
                                {
                                    <form method="post" asp-action="VerifyClaim" class="d-inline">
                                        <input type="hidden" name="id" value="@claim.Id" />
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="fas fa-check me-1"></i>Verify
                                        </button>
                                    </form>
                                    <button type="button" class="btn btn-danger btn-sm"
                                            data-bs-toggle="modal"
                                            data-bs-target="#rejectModal@(claim.Id)">
                                        <i class="fas fa-times me-1"></i>Reject
                                    </button>
                                }
                                else if (claim.Status == ProgrammingPOE.Models.ClaimStatus.RejectedByHR)
                                {
                                    <button type="button" class="btn btn-warning btn-sm"
                                            data-bs-toggle="modal"
                                            data-bs-target="#returnModal@(claim.Id)">
                                        <i class="fas fa-undo me-1"></i>Return to Lecturer
                                    </button>
                                }
                                <a href="@Url.Action("Details", new { id = claim.Id })"
                                   class="btn btn-info btn-sm">
                                    <i class="fas fa-eye me-1"></i>Details
                                </a>
                            </div>

                            <!-- Reject Modal -->
                            <div class="modal fade" id="rejectModal@(claim.Id)" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Reject Claim</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <form method="post" asp-action="RejectClaim">
                                            <div class="modal-body">
                                                <input type="hidden" name="id" value="@claim.Id" />
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    This claim will be rejected and the lecturer will be notified.
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">Rejection Reason:</label>
                                                    <textarea name="rejectionNotes" class="form-control"
                                                      rows="4"
                                                      placeholder="Please provide detailed reason for rejection. This will be sent to the lecturer..."
                                                      required></textarea>
                                                    <small class="form-text text-muted">
                                                        Be specific about what needs to be corrected or why the claim cannot be approved.
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-danger">
                                                    <i class="fas fa-times me-1"></i>Reject Claim
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Return to Lecturer Modal -->
                            <div class="modal fade" id="returnModal@(claim.Id)" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Return Claim to Lecturer</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <form method="post" asp-action="ReturnToLecturer">
                                            <div class="modal-body">
                                                <input type="hidden" name="id" value="@claim.Id" />
                                                <div class="alert alert-info">
                                                    <strong>HR Rejection Notes:</strong><br>
                                                    @claim.RejectionNotes
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">Additional Notes for Lecturer:</label>
                                                    <textarea name="correctionNotes" class="form-control"
                                                      rows="4"
                                                      placeholder="Add any additional notes or specific instructions for the lecturer..."
                                                      required></textarea>
                                                    <small class="form-text text-muted">
                                                        Explain what corrections are needed for the claim to be resubmitted successfully.
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-warning">
                                                    <i class="fas fa-undo me-1"></i>Return to Lecturer
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Summary Statistics -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white text-center">
                <div class="card-body">
                    <h5>Total Claims</h5>
                    <h3>@Model.Count</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark text-center">
                <div class="card-body">
                    <h5>Pending Verification</h5>
                    <h3>@Model.Count(c => c.Status == ProgrammingPOE.Models.ClaimStatus.Submitted)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white text-center">
                <div class="card-body">
                    <h5>Returned by HR</h5>
                    <h3>@Model.Count(c => c.Status == ProgrammingPOE.Models.ClaimStatus.RejectedByHR)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white text-center">
                <div class="card-body">
                    <h5>Ready for HR</h5>
                    <h3>@Model.Count(c => c.Status == ProgrammingPOE.Models.ClaimStatus.Verified)</h3>
                </div>
            </div>
        </div>
    </div>
}

<div class="mt-3">
    <a href="@Url.Action("Index", "Home")" class="btn btn-outline-secondary">
        <i class="fas fa-home me-1"></i>Back to Home
    </a>
</div>

@section Scripts {
    <script>
        // Select All functionality
        function toggleSelectAll(source) {
            const checkboxes = document.getElementsByClassName('claim-checkbox');
            for (let checkbox of checkboxes) {
                checkbox.checked = source.checked;
            }
            updateBulkActionButton();
        }

        // Update bulk action button state
        function updateBulkActionButton() {
            const selectedCount = document.querySelectorAll('.claim-checkbox:checked').length;
            const bulkButton = document.querySelector('button[onclick="performBulkAction()"]');

            if (selectedCount > 0) {
                bulkButton.textContent = `Execute Bulk Action (${selectedCount} selected)`;
                bulkButton.disabled = false;
            } else {
                bulkButton.textContent = 'Execute Bulk Action';
                bulkButton.disabled = false;
            }
        }

        // Initialize checkboxes event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.getElementsByClassName('claim-checkbox');
            for (let checkbox of checkboxes) {
                checkbox.addEventListener('change', updateBulkActionButton);
            }
        });

        // Perform bulk action
        function performBulkAction() {
            const selectedClaims = Array.from(document.getElementsByClassName('claim-checkbox'))
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            if (selectedClaims.length === 0) {
                alert('Please select at least one claim');
                return;
            }

            const action = document.getElementById('bulkAction').value;
            if (!action) {
                alert('Please select a bulk action');
                return;
            }

            if (confirm(`Are you sure you want to ${action} ${selectedClaims.length} claims?`)) {
                // Show loading state
                const bulkButton = document.querySelector('button[onclick="performBulkAction()"]');
                const originalText = bulkButton.innerHTML;
                bulkButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
                bulkButton.disabled = true;

                // Simulate API call - in real application, this would be an AJAX call to your backend
                setTimeout(() => {
                    if (action === 'verify') {
                        // Simulate bulk verification
                        alert(`Successfully verified ${selectedClaims.length} claims! They have been sent to HR Manager for final approval.`);
                    } else if (action === 'reject') {
                        // For rejection, we need to show a modal for rejection notes
                        showBulkRejectionModal(selectedClaims);
                    }

                    // Reset button
                    bulkButton.innerHTML = originalText;
                    bulkButton.disabled = false;

                    // Uncheck all boxes
                    document.getElementById('selectAll').checked = false;
                    const checkboxes = document.getElementsByClassName('claim-checkbox');
                    for (let checkbox of checkboxes) {
                        checkbox.checked = false;
                    }
                    updateBulkActionButton();

                }, 1500);
            }
        }

        // Show bulk rejection modal
        function showBulkRejectionModal(claimIds) {
            // Create a dynamic modal for bulk rejection notes
            const modalHtml = `
                <div class="modal fade" id="bulkRejectModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Bulk Reject Claims</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form id="bulkRejectForm">
                                <div class="modal-body">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        You are about to reject ${claimIds.length} claims. This action cannot be undone.
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Rejection Reason (applies to all selected claims):</label>
                                        <textarea name="bulkRejectionNotes" class="form-control"
                                                  rows="4"
                                                  placeholder="Please provide the reason for rejecting these claims..."
                                                  required></textarea>
                                        <small class="form-text text-muted">
                                            This reason will be sent to all affected lecturers.
                                        </small>
                                    </div>
                                    <input type="hidden" name="claimIds" value="${claimIds.join(',')}">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-danger">
                                        <i class="fas fa-times me-1"></i>Reject ${claimIds.length} Claims
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml');

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('bulkRejectModal'));
            modal.show();

            // Handle form submission
            document.getElementById('bulkRejectForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const notes = this.bulkRejectionNotes.value;
                alert(`Bulk rejection completed! ${claimIds.length} claims rejected with reason: "${notes}"`);
                modal.hide();

                // Remove modal from DOM
                document.getElementById('bulkRejectModal').remove();
            });

            // Remove modal from DOM when hidden
            document.getElementById('bulkRejectModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // Auto-validation for claims
        function validateClaim(claimId) {
            // This would call your backend validation service
            console.log(`Validating claim ${claimId}...`);
            // In a real app, this would be an AJAX call to your ValidationService
        }
    </script>
}